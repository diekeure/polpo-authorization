!function(){"use strict";angular.module("polpo.authorization",["ui.router"])}(),function(){"use strict";function e(e,n){return{transclude:"element",priority:600,restrict:"A",scope:{roles:"@dkAccess",type:"@dkAccessType",owner:"@dkAccessOwner"},link:function(r,i,t,o,l){function u(){var t=e.authorize(f,g,p)===!0?!0:!1;t?d||l(function(e,t){d=t,e[e.length++]=document.createComment(" end dkAccess: "+r.roles+" "),s={clone:e},n.enter(e,i.parent(),i)}):(c&&(c.remove(),c=null),d&&(d.$destroy(),d=null),s&&(c=a(s.clone),n.leave(c).then(function(){c=null}),s=null))}function a(e){var n=e[0],r=e[e.length-1],i=[n];do{if(n=n.nextSibling,!n)break;i.push(n)}while(n!==r);return angular.element(i)}var s,d,c,f=r.roles,g=r.type,p=r.owner;switch(f){case"*":f=void 0;break;case"!":break;case"":f=[];break;default:f=f.split(",")}r.$watch(function(){return e.getUserRoles()},function(){u()})}}}angular.module("polpo.authorization").directive("dkAccess",e),e.$inject=["AuthService","$animate"]}(),function(){"use strict";function e(){var e=null,n={allowedRoles:[],allowedTypes:[],ignore:null,onLogin:null,onDenied:null,resolve:null,rolesMap:null,userId:"id",userRoles:"roles",userType:"type"},r=!0,i=!0,t=!0;this.settings=function(e){return void 0!==e&&(angular.extend(n,e),n.resolve&&(r=!1),angular.isString(n.allowedRoles)&&(n.allowedRoles=[n.allowedRoles]),i=0===n.allowedRoles.length,angular.isString(n.allowedTypes)&&(n.allowedTypes=[n.allowedTypes]),t=0===n.allowedTypes.length),n},this.$get=function(o,l,u){function a(e,r,i){function t(){var i=d(r);return i!==!0?(i===!1?n.onDenied&&u.invoke(n.onDenied):"login"===i&&n.onLogin&&u.invoke(n.onLogin),e.preventDefault()):void 0}if(!n.ignore||!n.ignore(r.name))return c()===!1?(u.invoke(n.resolve).then(function(e){c(e),l.$state.go(r.name,i,{reload:!0})},function(){return n.onLogin?u.invoke(n.onLogin):!1}),e.preventDefault()):t()}function s(r,o,l){var u={authorized:!0,unauthorized:!1,loginRequired:"login"},a={one:!1,all:!0},s=angular.merge({superuser:["superuser","editoradmin","editor","author"],editoradmin:["editoradmin","editor","author"],editor:["editor","author"],schooladmin:["schooladmin","teacher"]},n.rolesMap||{});angular.forEach(s,function(e,n){angular.isString(e)&&(s[n]=[e])});var d,c,g,p=[],h=f();if(angular.isString(o)&&(o=a[o]),o=o||a.one,void 0===r)return u.authorized;if("!"===r)return null===e?u.authorized:u.unauthorized;if(null===e)return u.loginRequired;if(t===!1||i===!1)return u.loginRequired;if(void 0!==l&&l.toString()===e.id.toString())return u.authorized;if(angular.isArray(r)||(r=r.split(",")),0===r.length)return u.authorized;if(null===h||0===h.length)return u.unauthorized;for(g=h.length,d=0;g>d;d++)c=h[d].name,void 0===s[c]&&(s[c]=[c]),p=p.concat(s[c]);if(g=r.length,o===a.all){for(d=0;g>d;d++)if(c=r[d],-1===p.indexOf(c))return u.unauthorized;return u.authorized}if(o===a.one){for(d=0;g>d;d++)if(c=r[d],p.indexOf(c)>-1)return u.authorized;return u.unauthorized}return u.unauthorized}function d(e){function n(e,r){var i,t,l,u,a=o.get(e);if(r=r||{},null===a)return r;if(i=a.dkAccess||{},void 0!==i.permissions)for(r.permissions=r.permissions||[],u=i.permissions.length,l=0;u>l;l++)-1===r.permissions.indexOf(i.permissions[l])&&r.permissions.push(i.permissions[l]);if(void 0!==i.type&&(r.type=i.type),i.inherit!==!1){if(void 0===a.parent)t=e.split(".").slice(0,-1).join(".");else if(angular.isString(a.parent))t=a.parent;else{if(!angular.isObject(a.parent))return r;t=a.parent.name}return n(t,r)}return r}var r=n(e.name,e.dkAccess),i=s(r.permissions,r.type);return i}function c(o){if(void 0!==o&&(e=o,r=!0,i=0===n.allowedRoles.length,t=0===n.allowedTypes.length,null!==o)){if(i===!1){var l=o[n.userRoles].filter(function(e){return-1!==n.allowedRoles.indexOf(e.name)});i=0!==l.length}t===!1&&(t=-1!==n.allowedTypes.indexOf(o[n.userType]))}return r?e:!1}function f(){return e?e[n.userRoles]:null}return l.$on("$stateChangeStart",a),{authorize:s,user:c,getUserRoles:f}},this.$get.$inject=["$state","$rootScope","$injector"]}angular.module("polpo.authorization").provider("AuthService",e)}();