!function(){"use strict";angular.module("polpo.authorization",["ui.router","lbServices","ngCookies"])}(),function(){"use strict";function e(e,n){function r(e,n,r,o,t,i){function u(e){for(var n=window.location.search.substring(1),r=n.split("&"),o=0;o<r.length;o++){var t=r[o].split("=");if(decodeURIComponent(t[0])===e)return decodeURIComponent(t[1])}}if(e.getCurrentUser=function(i,u){var s=o.user();if(angular.isFunction(i)&&(u=i,i=!1),!i&&s)return u?u(s):r.when(s);var l=e.getCurrent().$promise;return l.then(function(e){return o.user(e),n.$emit("user.update",e),u?u(e):void 0})["catch"](function(e){401===e.status&&(t.currentUserId=null,t.accessTokenId=null,t.save())}),l},!e.isAuthenticated()){var s=i.search();t.currentUserId=s.userId||u("userId"),t.accessTokenId=s.accessToken||u("accessToken"),t.save()}if(void 0!==u("accessToken")){var l=window.location.href.replace("userId="+t.currentUserId,"").replace("accessToken="+t.accessTokenId,"");l=l.replace(new RegExp(/\?\&/,"g"),"?"),l=l.replace(new RegExp(/\?\#/,"g"),"#"),l=l.replace(new RegExp(/\#\?/,"g"),"#"),window.location.replace(l)}return e}e.decorator("Person",r),r.$inject=["$delegate","$rootScope","$q","AuthService","LoopBackAuth","$location"],n.settings({})}angular.module("polpo.authorization").config(e),e.$inject=["$provide","AuthServiceProvider"]}(),function(){"use strict";function e(e,n){return{transclude:"element",priority:600,restrict:"A",scope:{roles:"@dkAccess",type:"@dkAccessType",owner:"@dkAccessOwner"},link:function(r,o,t,i,u){function s(){var t=e.authorize(f,g,p)===!0?!0:!1;t?c||u(function(e,t){c=t,e[e.length++]=document.createComment(" end dkAccess: "+r.roles+" "),a={clone:e},n.enter(e,o.parent(),o)}):(d&&(d.remove(),d=null),c&&(c.$destroy(),c=null),a&&(d=l(a.clone),n.leave(d).then(function(){d=null}),a=null))}function l(e){var n=e[0],r=e[e.length-1],o=[n];do{if(n=n.nextSibling,!n)break;o.push(n)}while(n!==r);return angular.element(o)}var a,c,d,f=r.roles,g=r.type,p=r.owner;switch(f){case"*":f=void 0;break;case"!":break;case"":f=[];break;default:f=f.split(",")}r.$watch(function(){return e.getUserRoles()},function(){s()})}}}angular.module("polpo.authorization").directive("dkAccess",e),e.$inject=["AuthService","$animate"]}(),function(){"use strict";function e(){function e(e,u,s,l){function a(e,n,o){function t(){var o=d(n);return o!==!0?(o===!1?r.onDenied&&s.invoke(r.onDenied):"login"===o&&r.onLogin&&s.invoke(r.onLogin),e.preventDefault()):void 0}if(!r.ignore||!r.ignore(n.name))return f()===!1?(s.invoke(r.resolve).then(function(e){f(e),u.$state.go(n.name,o,{reload:!0})},function(){return r.onLogin?s.invoke(r.onLogin):!1}),e.preventDefault()):t()}function c(e,o,u){var s={authorized:!0,unauthorized:!1,loginRequired:"login"},l={one:!1,all:!0},a=angular.merge({superuser:["superuser","editoradmin","editor","author"],editoradmin:["editoradmin","editor","author"],editor:["editor","author"],schooladmin:["schooladmin","teacher"]},r.rolesMap||{});angular.forEach(a,function(e,n){angular.isString(e)&&(a[n]=[e])});var c,d,f,p=[],h=g();if(angular.isString(o)&&(o=l[o]),o=o||l.one,void 0===e)return s.authorized;if("!"===e)return null===n?s.authorized:s.unauthorized;if(null===n)return s.loginRequired;if(i===!1||t===!1)return s.loginRequired;if(void 0!==u&&u.toString()===n.id.toString())return s.authorized;if(angular.isArray(e)||(e=e.split(",")),0===e.length)return s.authorized;if(null===h||0===h.length)return s.unauthorized;for(f=h.length,c=0;f>c;c++)d=h[c].name,void 0===a[d]&&(a[d]=[d]),p=p.concat(a[d]);if(f=e.length,o===l.all){for(c=0;f>c;c++)if(d=e[c],-1===p.indexOf(d))return s.unauthorized;return s.authorized}if(o===l.one){for(c=0;f>c;c++)if(d=e[c],p.indexOf(d)>-1)return s.authorized;return s.unauthorized}return s.unauthorized}function d(n){function r(n,o){var t,i,u,s,l=e.get(n);if(o=o||{},null===l)return o;if(t=l.dkAccess||{},void 0!==t.permissions)for(o.permissions=o.permissions||[],s=t.permissions.length,u=0;s>u;u++)-1===o.permissions.indexOf(t.permissions[u])&&o.permissions.push(t.permissions[u]);if(void 0!==t.type&&(o.type=t.type),t.inherit!==!1){if(void 0===l.parent)i=n.split(".").slice(0,-1).join(".");else if(angular.isString(l.parent))i=l.parent;else{if(!angular.isObject(l.parent))return o;i=l.parent.name}return r(i,o)}return o}var o=r(n.name,n.dkAccess),t=c(o.permissions,o.type);return t}function f(e){if(void 0!==e&&(n=e,o=!0,t=0===r.allowedRoles.length,i=0===r.allowedTypes.length,null!==e)){if(t===!1){var u=e[r.userRoles].filter(function(e){return-1!==r.allowedRoles.indexOf(e.name)});t=0!==u.length}i===!1&&(i=-1!==r.allowedTypes.indexOf(e[r.userType]))}return o?n:!1}function g(){return n?n[r.userRoles]:null}function p(){return s.invoke(r.resolve)}function h(){s.invoke(r.logout),l.remove("access_token"),l.remove("userId"),f(null)}return r.ignore!==!0&&u.$on("$stateChangeStart",a),{authorize:c,user:f,getUserRoles:g,userPromise:p,logout:h}}var n=null,r={allowedRoles:[],allowedTypes:[],ignore:!0,onLogin:null,onDenied:null,resolve:function(e){return e.getCurrentUser()},rolesMap:null,userId:"id",userRoles:"roles",userType:"type",logout:function(e){return e.logout()}},o=!0,t=!0,i=!0;r.resolve.$inject=["Person"],r.logout.$inject=["Person"],this.settings=function(e){return void 0!==e&&(angular.extend(r,e),r.resolve&&(o=!1),angular.isString(r.allowedRoles)&&(r.allowedRoles=[r.allowedRoles]),t=0===r.allowedRoles.length,angular.isString(r.allowedTypes)&&(r.allowedTypes=[r.allowedTypes]),i=0===r.allowedTypes.length),r},this.$get=e,e.$inject=["$state","$rootScope","$injector","$cookies"]}angular.module("polpo.authorization").provider("AuthService",e)}();