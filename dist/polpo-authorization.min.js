!function(){"use strict";angular.module("polpo.authorization",["ui.router","lbServices"])}(),function(){"use strict";function e(e,n){function r(e,n,r,t){return e.getCurrentUser=function(i,o){var u=e.getCachedCurrent();if(angular.isFunction(i)&&(o=i,i=!1),!i&&u)return o?o(u):r.when(u);var l=e.getCurrent({filter:{include:["personPreferences","roles"]}}).$promise;return l.then(function(e){return t.user(e),n.$emit("user.update",e),o?o(e):void 0}),l},e}e.decorator("Person",r),r.$inject=["$delegate","$rootScope","$q","AuthService"],n.settings({})}angular.module("polpo.authorization").config(e),e.$inject=["$provide","AuthServiceProvider"]}(),function(){"use strict";function e(e,n){return{transclude:"element",priority:600,restrict:"A",scope:{roles:"@dkAccess",type:"@dkAccessType",owner:"@dkAccessOwner"},link:function(r,t,i,o,u){function l(){var i=e.authorize(f,g,p)===!0?!0:!1;i?d||u(function(e,i){d=i,e[e.length++]=document.createComment(" end dkAccess: "+r.roles+" "),a={clone:e},n.enter(e,t.parent(),t)}):(c&&(c.remove(),c=null),d&&(d.$destroy(),d=null),a&&(c=s(a.clone),n.leave(c).then(function(){c=null}),a=null))}function s(e){var n=e[0],r=e[e.length-1],t=[n];do{if(n=n.nextSibling,!n)break;t.push(n)}while(n!==r);return angular.element(t)}var a,d,c,f=r.roles,g=r.type,p=r.owner;switch(f){case"*":f=void 0;break;case"!":break;case"":f=[];break;default:f=f.split(",")}r.$watch(function(){return e.getUserRoles()},function(){l()})}}}angular.module("polpo.authorization").directive("dkAccess",e),e.$inject=["AuthService","$animate"]}(),function(){"use strict";function e(){function e(e,u,l){function s(e,n,t){function i(){var t=d(n);return t!==!0?(t===!1?r.onDenied&&l.invoke(r.onDenied):"login"===t&&r.onLogin&&l.invoke(r.onLogin),e.preventDefault()):void 0}if(!r.ignore||!r.ignore(n.name))return c()===!1?(l.invoke(r.resolve).then(function(e){c(e),u.$state.go(n.name,t,{reload:!0})},function(){return r.onLogin?l.invoke(r.onLogin):!1}),e.preventDefault()):i()}function a(e,t,u){var l={authorized:!0,unauthorized:!1,loginRequired:"login"},s={one:!1,all:!0},a=angular.merge({superuser:["superuser","editoradmin","editor","author"],editoradmin:["editoradmin","editor","author"],editor:["editor","author"],schooladmin:["schooladmin","teacher"]},r.rolesMap||{});angular.forEach(a,function(e,n){angular.isString(e)&&(a[n]=[e])});var d,c,g,p=[],h=f();if(angular.isString(t)&&(t=s[t]),t=t||s.one,void 0===e)return l.authorized;if("!"===e)return null===n?l.authorized:l.unauthorized;if(null===n)return l.loginRequired;if(o===!1||i===!1)return l.loginRequired;if(void 0!==u&&u.toString()===n.id.toString())return l.authorized;if(angular.isArray(e)||(e=e.split(",")),0===e.length)return l.authorized;if(null===h||0===h.length)return l.unauthorized;for(g=h.length,d=0;g>d;d++)c=h[d].name,void 0===a[c]&&(a[c]=[c]),p=p.concat(a[c]);if(g=e.length,t===s.all){for(d=0;g>d;d++)if(c=e[d],-1===p.indexOf(c))return l.unauthorized;return l.authorized}if(t===s.one){for(d=0;g>d;d++)if(c=e[d],p.indexOf(c)>-1)return l.authorized;return l.unauthorized}return l.unauthorized}function d(n){function r(n,t){var i,o,u,l,s=e.get(n);if(t=t||{},null===s)return t;if(i=s.dkAccess||{},void 0!==i.permissions)for(t.permissions=t.permissions||[],l=i.permissions.length,u=0;l>u;u++)-1===t.permissions.indexOf(i.permissions[u])&&t.permissions.push(i.permissions[u]);if(void 0!==i.type&&(t.type=i.type),i.inherit!==!1){if(void 0===s.parent)o=n.split(".").slice(0,-1).join(".");else if(angular.isString(s.parent))o=s.parent;else{if(!angular.isObject(s.parent))return t;o=s.parent.name}return r(o,t)}return t}var t=r(n.name,n.dkAccess),i=a(t.permissions,t.type);return i}function c(e){if(void 0!==e&&(n=e,t=!0,i=0===r.allowedRoles.length,o=0===r.allowedTypes.length,null!==e)){if(i===!1){var u=e[r.userRoles].filter(function(e){return-1!==r.allowedRoles.indexOf(e.name)});i=0!==u.length}o===!1&&(o=-1!==r.allowedTypes.indexOf(e[r.userType]))}return t?n:!1}function f(){return n?n[r.userRoles]:null}function g(){return l.invoke(r.resolve)}return r.ignore!==!0&&u.$on("$stateChangeStart",s),{authorize:a,user:c,getUserRoles:f,userPromise:g}}var n=null,r={allowedRoles:[],allowedTypes:[],ignore:!0,onLogin:null,onDenied:null,resolve:function(e){return e.getCurrentUser()},rolesMap:null,userId:"id",userRoles:"roles",userType:"type"},t=!0,i=!0,o=!0;r.resolve.$inject=["Person"],this.settings=function(e){return void 0!==e&&(angular.extend(r,e),r.resolve&&(t=!1),angular.isString(r.allowedRoles)&&(r.allowedRoles=[r.allowedRoles]),i=0===r.allowedRoles.length,angular.isString(r.allowedTypes)&&(r.allowedTypes=[r.allowedTypes]),o=0===r.allowedTypes.length),r},this.$get=e,e.$inject=["$state","$rootScope","$injector"]}angular.module("polpo.authorization").provider("AuthService",e)}();