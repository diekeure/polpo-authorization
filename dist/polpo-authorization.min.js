!function(){"use strict";angular.module("polpo.authorization",["ui.router"])}(),function(){"use strict";function e(e,n){return{transclude:"element",priority:600,restrict:"A",scope:{roles:"@dkAccess",type:"@dkAccessType",owner:"@dkAccessOwner"},link:function(r,i,t,o,u){function a(){var t=e.authorize(f,h,g)===!0?!0:!1;t?c||u(function(e,t){c=t,e[e.length++]=document.createComment(" end dkAccess: "+r.roles+" "),l={clone:e},n.enter(e,i.parent(),i)}):(d&&(d.remove(),d=null),c&&(c.$destroy(),c=null),l&&(d=s(l.clone),n.leave(d).then(function(){d=null}),l=null))}function s(e){var n=e[0],r=e[e.length-1],i=[n];do{if(n=n.nextSibling,!n)break;i.push(n)}while(n!==r);return angular.element(i)}var l,c,d,f=r.roles,h=r.type,g=r.owner;switch(f){case"*":f=void 0;break;case"!":break;case"":f=[];break;default:f=f.split(",")}r.$watch(function(){return e.getUserRoles()},function(){a()})}}}angular.module("polpo.authorization").directive("dkAccess",e),e.$inject=["AuthService","$animate"]}(),function(){"use strict";function e(){var e=null,n={ignore:null,onLogin:null,onDenied:null,resolve:null,rolesMap:null,userId:"id",userRoles:"roles"},r=!0;this.settings=function(e){return void 0!==e&&(angular.extend(n,e),n.resolve&&(r=!1)),n},this.$get=function(i,t,o){function u(e,r,i){function u(){var i=s(r);return i!==!0?(i===!1?n.onDenied&&o.invoke(n.onDenied):"login"===i&&n.onLogin&&o.invoke(n.onLogin),e.preventDefault()):void 0}if(!n.ignore||!n.ignore(r.name))return l()===!1?(o.invoke(n.resolve).then(function(e){l(e),t.$state.go(r.name,i,{reload:!0})},function(){return n.onLogin?o.invoke(n.onLogin):!1}),e.preventDefault()):u()}function a(r,i,t){var o={authorized:!0,unauthorized:!1,loginRequired:"login"},u={one:!1,all:!0},a=angular.merge({superuser:["superuser","editoradmin","editor","author"],editoradmin:["editoradmin","editor","author"],editor:["editor","author"],schooladmin:["schooladmin","teacher"]},n.rolesMap||{});angular.forEach(a,function(e,n){angular.isString(e)&&(a[n]=[e])});var s,l,d,f=[],h=c();if(angular.isString(i)&&(i=u[i]),i=i||u.one,void 0===r)return o.authorized;if("!"===r)return null===e?o.authorized:o.unauthorized;if(null===e)return o.loginRequired;if(void 0!==t&&t.toString()===e.id.toString())return o.authorized;if(0===r.length)return o.authorized;if(null===h||0===h.length)return o.unauthorized;for(s=0,d=h.length;d>s;s++)l=h[s].name,void 0===a[l]&&(a[l]=[l]),f=f.concat(a[l]);if(i===u.all){for(s=0,d=r.length;d>s;s++)if(l=r[s],-1===f.indexOf(l))return o.unauthorized;return o.authorized}if(i===u.one){for(s=0,d=r.length;d>s;s++)if(l=r[s],f.indexOf(l)>-1)return o.authorized;return o.unauthorized}return o.unauthorized}function s(e){function n(e,r){var t,o,u,a,s=i.get(e);if(r=r||{},null===s)return r;if(t=s.dkAccess||{},void 0!==t.permissions)for(r.permissions=r.permissions||[],u=0,a=t.permissions.length;a>u;u++)-1===r.permissions.indexOf(t.permissions[u])&&r.permissions.push(t.permissions[u]);if(void 0!==t.type&&(r.type=t.type),t.inherit!==!1){if(void 0===s.parent)o=e.split(".").slice(0,-1).join(".");else if(angular.isString(s.parent))o=s.parent;else{if(!angular.isObject(s.parent))return r;o=s.parent.name}return n(o,r)}return r}var r=n(e.name,e.dkAccess),t=a(r.permissions,r.type);return t}function l(n){return void 0!==n&&(e=n,r=!0),r?e:!1}function c(){return e?e[n.userRoles]:null}return t.$on("$stateChangeStart",u),{authorize:a,user:l,getUserRoles:c}},this.$get.$inject=["$state","$rootScope","$injector"]}angular.module("polpo.authorization").provider("AuthService",e)}();